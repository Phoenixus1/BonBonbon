<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion Pro Elite - Cloud</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{--bg:#f8fafc;--card:#fff;--text:#0f172a;--text-light:#64748b;--accent:#2563eb;--victor:#2563eb;--arthur:#10b981;--border:#e2e8f0;--hover:#f1f5f9;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--radius:20px;--radius-sm:12px;--shadow:0 10px 25px rgba(0,0,0,0.06)}
body.dark{--bg:#0f172a;--card:#1e293b;--text:#f1f5f9;--text-light:#94a3b8;--border:#334155;--hover:#2d3a4f}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',system-ui,sans-serif}
body{background:var(--bg);color:var(--text);min-height:100vh;transition:background .3s,color .2s}
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1e3a8a 0%,#065f46 100%);padding:20px}
.login-box{background:var(--card);padding:44px;border-radius:var(--radius);box-shadow:0 30px 60px rgba(0,0,0,0.3);width:100%;max-width:420px}
.login-logo{text-align:center;margin-bottom:28px}
.login-logo .ico{font-size:44px;margin-bottom:10px}
.login-logo h1{font-size:24px;font-weight:800;background:linear-gradient(135deg,var(--victor),var(--arthur));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-logo p{color:var(--text-light);font-size:13px;margin-top:5px}
.login-users{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px}
.user-btn{padding:14px;border-radius:var(--radius-sm);border:2px solid var(--border);background:var(--bg);cursor:pointer;text-align:center;transition:all .3s;color:var(--text)}
.user-btn.victor.selected,.user-btn.victor:hover{border-color:var(--victor);background:rgba(37,99,235,.08)}
.user-btn.arthur.selected,.user-btn.arthur:hover{border-color:var(--arthur);background:rgba(16,185,129,.08)}
.user-btn .ico{font-size:26px;margin-bottom:6px}
.user-btn.victor .ico{color:var(--victor)}
.user-btn.arthur .ico{color:var(--arthur)}
.user-btn strong{display:block;font-size:15px}
.user-btn small{font-size:11px;color:var(--text-light)}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-weight:600;font-size:13px;margin-bottom:7px}
input,select,textarea{width:100%;padding:13px 15px;border-radius:var(--radius-sm);border:2px solid var(--border);background:var(--bg);color:var(--text);font-size:14px;outline:none;transition:border .2s}
input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.btn{padding:14px 22px;border-radius:var(--radius-sm);border:none;font-weight:600;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;background:var(--accent);color:#fff;transition:all .3s;width:100%}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(37,99,235,.3)}
.btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
.btn.danger{background:var(--danger)}.btn.success{background:var(--success)}.btn.warning{background:var(--warning)}
.btn.sm{padding:9px 14px;font-size:12px;width:auto}.btn.ghost{background:transparent;color:var(--text);border:2px solid var(--border)}
.btn.ghost:hover{background:var(--hover);box-shadow:none}
.app{display:none}.app.active{display:block}
.topbar{background:var(--card);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;box-shadow:var(--shadow)}
.topbar-left{display:flex;align-items:center;gap:14px}
.logo-txt{font-size:17px;font-weight:800;background:linear-gradient(135deg,var(--victor),var(--arthur));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.menu-btn{background:none;border:none;color:var(--text);font-size:19px;cursor:pointer;padding:9px;border-radius:var(--radius-sm);transition:background .2s}
.menu-btn:hover{background:var(--hover)}
.page-title{font-size:16px;font-weight:600}
.topbar-right{display:flex;align-items:center;gap:10px}
.user-pill{padding:7px 14px;border-radius:30px;display:flex;align-items:center;gap:7px;font-weight:600;font-size:13px;color:#fff}
.sync-badge{padding:7px 12px;border-radius:30px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px;border:1px solid var(--border);background:var(--card);transition:all .3s}
.sync-badge.syncing{border-color:var(--warning);color:var(--warning);background:rgba(245,158,11,.08)}
.sync-badge.synced{border-color:var(--success);color:var(--success);background:rgba(16,185,129,.08)}
.sync-badge.error{border-color:var(--danger);color:var(--danger);background:rgba(239,68,68,.08)}
@keyframes spin{to{transform:rotate(360deg)}}
.spinning{display:inline-block;animation:spin 1s linear infinite}
.sidebar{position:fixed;top:0;left:-310px;width:285px;height:100vh;background:var(--card);border-right:1px solid var(--border);z-index:99;transition:left .4s cubic-bezier(.16,1,.3,1);display:flex;flex-direction:column;overflow-y:auto;box-shadow:4px 0 20px rgba(0,0,0,.08)}
.sidebar.open{left:0}
.sidebar-head{padding:22px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.sidebar-head .ico{font-size:26px;color:var(--accent)}
.sidebar-head h2{font-size:17px;font-weight:700}
.sidebar-menu{flex:1;padding:14px 10px;display:flex;flex-direction:column;gap:5px}
.nav-item{display:flex;align-items:center;gap:13px;padding:13px 14px;border-radius:var(--radius-sm);cursor:pointer;color:var(--text);font-weight:500;transition:all .3s}
.nav-item:hover{background:var(--hover);transform:translateX(3px)}
.nav-item.active{background:var(--accent);color:#fff;box-shadow:0 5px 14px rgba(37,99,235,.3)}
.nav-item .ico{width:20px;text-align:center;font-size:17px}
.nav-badge{margin-left:auto;padding:2px 7px;border-radius:20px;font-size:11px;background:rgba(255,255,255,.25)}
.sidebar-foot{padding:14px 10px;border-top:1px solid var(--border)}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:98;backdrop-filter:blur(2px)}
.overlay.active{display:block}
.content{padding:26px;max-width:1500px;margin:0 auto}
.tab{display:none}.tab.active{display:block;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--card);border-radius:var(--radius);padding:22px;margin-bottom:22px;border:1px solid var(--border);box-shadow:var(--shadow);position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:linear-gradient(to bottom,var(--accent),transparent)}
.card-title{font-size:17px;font-weight:700;margin-bottom:18px;display:flex;align-items:center;gap:9px}
.card-title .ico{color:var(--accent);font-size:18px}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:22px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:22px}
.grid4{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px}
.grid-products{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:22px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;text-align:center;transition:all .3s;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px;background:linear-gradient(90deg,var(--victor),var(--arthur))}
.stat-card:hover{transform:translateY(-3px);box-shadow:var(--shadow)}
.stat-icon{width:52px;height:52px;margin:0 auto 12px;background:rgba(37,99,235,.1);border-radius:14px;display:flex;align-items:center;justify-content:center}
.stat-num{font-size:26px;font-weight:800;color:var(--accent);margin-bottom:5px}
.stat-lbl{font-size:11px;color:var(--text-light);text-transform:uppercase;letter-spacing:1px}
.tbl-wrap{overflow-x:auto;border-radius:var(--radius-sm);margin-top:14px}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:13px 14px;background:var(--bg);font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--accent);color:var(--text-light)}
td{padding:13px 14px;border-bottom:1px solid var(--border);font-size:13px}
tr:hover td{background:var(--hover)}
.badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600}
.b-success{background:rgba(16,185,129,.12);color:#10b981;border:1px solid rgba(16,185,129,.25)}
.b-warning{background:rgba(245,158,11,.12);color:#f59e0b;border:1px solid rgba(245,158,11,.25)}
.b-danger{background:rgba(239,68,68,.12);color:#ef4444;border:1px solid rgba(239,68,68,.25)}
.b-info{background:rgba(37,99,235,.12);color:#2563eb;border:1px solid rgba(37,99,235,.25)}
.b-victor{background:rgba(37,99,235,.15);color:#2563eb}.b-arthur{background:rgba(16,185,129,.15);color:#10b981}
.prod-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:all .3s;position:relative;overflow:hidden}
.prod-card:hover{transform:translateY(-5px);box-shadow:var(--shadow)}
.stock-bar{width:100%;height:7px;background:var(--border);border-radius:4px;margin:10px 0;overflow:hidden}
.stock-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--arthur));border-radius:4px;transition:width .5s}
.upload-zone{border:2px dashed var(--border);border-radius:var(--radius-sm);padding:36px 20px;text-align:center;cursor:pointer;transition:all .3s}
.upload-zone:hover,.upload-zone.drag{border-color:var(--accent);background:rgba(37,99,235,.04)}
.file-item{display:flex;align-items:center;justify-content:space-between;padding:11px;background:var(--bg);border-radius:var(--radius-sm);margin-top:9px;transition:all .2s}
.file-item:hover{background:var(--hover)}
.file-thumb{width:44px;height:44px;border-radius:9px;object-fit:cover;border:1px solid var(--border)}
.file-icon-box{width:44px;height:44px;border-radius:9px;background:rgba(37,99,235,.1);display:flex;align-items:center;justify-content:center;color:var(--accent);font-size:18px}
.toast{position:fixed;bottom:24px;right:24px;padding:13px 20px;border-radius:var(--radius-sm);color:#fff;font-weight:600;z-index:9999;display:none;align-items:center;gap:9px;box-shadow:0 10px 30px rgba(0,0,0,.2);animation:slideUp .3s}
.toast.show{display:flex}
@keyframes slideUp{from{transform:translateY(18px);opacity:0}to{transform:translateY(0);opacity:1}}
.toast.s{background:var(--success)}.toast.e{background:var(--danger)}.toast.w{background:var(--warning)}.toast.i{background:var(--accent)}
.cal-header{display:grid;grid-template-columns:repeat(7,1fr);gap:7px;margin-bottom:7px}
.cal-day-name{text-align:center;font-weight:700;color:var(--accent);font-size:12px;padding:9px;background:var(--bg);border-radius:7px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:7px}
.cal-day{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 7px;min-height:90px;cursor:pointer;transition:all .2s}
.cal-day:hover{background:var(--hover);transform:scale(1.02)}
.cal-day.today{border-color:var(--accent);box-shadow:0 0 0 2px rgba(37,99,235,.15)}
.cal-num{font-weight:700;font-size:15px;color:var(--accent);margin-bottom:5px}
.cal-event{font-size:10px;padding:3px 6px;border-radius:5px;margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-left:3px solid var(--accent);background:rgba(37,99,235,.08);color:var(--accent)}
.chart-wrap{position:relative;height:300px}
@media(max-width:900px){.grid2,.grid3{grid-template-columns:1fr}.cal-grid{grid-template-columns:repeat(2,1fr)}.cal-header{display:none}}
@media(max-width:480px){.grid4{grid-template-columns:1fr 1fr}.content{padding:14px}}
</style>
</head>
<body>

<div class="login-wrap" id="loginWrap">
  <div class="login-box">
    <div class="login-logo">
      <div class="ico">â˜ï¸</div>
      <h1>Gestion Pro Cloud</h1>
      <p>Synchronisation Supabase activÃ©e</p>
    </div>
    <p style="font-size:13px;font-weight:600;margin-bottom:11px;color:var(--text-light)">Choisissez votre profil</p>
    <div class="login-users">
      <button class="user-btn victor" onclick="selectUser('victor')" id="btn-victor">
        <div class="ico">ğŸ‘¤</div><strong>Victor</strong><small>victor@gestionpro.fr</small>
      </button>
      <button class="user-btn arthur" onclick="selectUser('arthur')" id="btn-arthur">
        <div class="ico">ğŸ‘¤</div><strong>Arthur</strong><small>arthur@gestionpro.fr</small>
      </button>
    </div>
    <div class="form-group">
      <label>ğŸ”’ Mot de passe</label>
      <input type="password" id="loginPwd" placeholder="6 caractÃ¨res minimum" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="btn" id="loginBtn" onclick="doLogin()">âœ Se connecter</button>
    <p id="loginMsg" style="text-align:center;margin-top:14px;font-size:12px;color:var(--text-light)">PremiÃ¨re connexion ? Le compte sera crÃ©Ã© automatiquement.</p>
  </div>
</div>

<div class="app" id="app">
  <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-head"><div class="ico">ğŸ“Š</div><h2>Gestion Pro</h2></div>
    <div class="sidebar-menu">
      <div class="nav-item active" onclick="goTab('dashboard',this)"><div class="ico">ğŸ </div><span>Tableau de bord</span></div>
      <div class="nav-item" onclick="goTab('transactions',this)"><div class="ico">ğŸ”„</div><span>Transactions</span><span class="nav-badge" id="nb-transactions" style="display:none">0</span></div>
      <div class="nav-item" onclick="goTab('boxes',this)"><div class="ico">ğŸ“¦</div><span>Boxes / Lots</span></div>
      <div class="nav-item" onclick="goTab('products',this)"><div class="ico">ğŸ›ï¸</div><span>Produits</span><span class="nav-badge" id="nb-products" style="display:none">0</span></div>
      <div class="nav-item" onclick="goTab('stock',this)"><div class="ico">ğŸ­</div><span>Stocks</span><span class="nav-badge" id="nb-lowstock" style="display:none">âš </span></div>
      <div class="nav-item" onclick="goTab('calendar',this)"><div class="ico">ğŸ“…</div><span>Calendrier</span></div>
      <div class="nav-item" onclick="goTab('stats',this)"><div class="ico">ğŸ“ˆ</div><span>Statistiques</span></div>
      <div class="nav-item" onclick="goTab('clients',this)"><div class="ico">ğŸ‘¥</div><span>Clients</span></div>
      <div class="nav-item" onclick="goTab('files',this)"><div class="ico">ğŸ“</div><span>Fichiers Cloud</span></div>
    </div>
    <div class="sidebar-foot">
      <div class="nav-item" onclick="toggleDark()"><div class="ico">ğŸŒ™</div><span>Mode sombre</span></div>
      <div class="nav-item" style="color:var(--danger)" onclick="doLogout()"><div class="ico">ğŸšª</div><span>DÃ©connexion</span></div>
    </div>
  </div>

  <div class="topbar">
    <div class="topbar-left">
      <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
      <span class="logo-txt">â˜ Gestion Pro Cloud</span>
      <span class="page-title" id="pageTitle">Tableau de bord</span>
    </div>
    <div class="topbar-right">
      <div class="sync-badge synced" id="syncBadge"><span id="syncIco">â˜</span><span id="syncText">SynchronisÃ©</span></div>
      <div class="user-pill" id="userPill" style="background:var(--victor)"><span>ğŸ‘¤</span><span id="userLabel">Victor</span></div>
    </div>
  </div>

  <div class="content">
    <!-- DASHBOARD -->
    <div class="tab active" id="tab-dashboard">
      <div class="grid4">
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ’¶</div><div class="stat-num" id="s-total">0 â‚¬</div><div class="stat-lbl">Total combinÃ©</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px;color:var(--victor)">ğŸ‘¤</div><div class="stat-num" id="s-victor" style="color:var(--victor)">0 â‚¬</div><div class="stat-lbl">Victor</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px;color:var(--arthur)">ğŸ‘¤</div><div class="stat-num" id="s-arthur" style="color:var(--arthur)">0 â‚¬</div><div class="stat-lbl">Arthur</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ“†</div><div class="stat-num" id="s-month">0 â‚¬</div><div class="stat-lbl">Ce mois</div></div>
      </div>
      <div class="grid2">
        <div class="card">
          <div class="card-title" style="color:var(--victor)"><div class="ico">ğŸ‘¤</div>Victor â€” Ajouter un gain</div>
          <form onsubmit="addGain(event,'victor')">
            <div class="form-group"><label>Date</label><input type="date" id="v-date" required></div>
            <div class="form-group"><label>Montant (â‚¬)</label><input type="number" id="v-amount" placeholder="0.00" step="0.01" min="0" required></div>
            <div class="form-group"><label>Description</label><input type="text" id="v-desc" placeholder="Ex: Vente iPhone..."></div>
            <div class="form-group"><label>CatÃ©gorie</label><select id="v-cat"><option value="vente">Vente</option><option value="prestation">Prestation</option><option value="autre">Autre</option></select></div>
            <button type="submit" class="btn" style="background:var(--victor)">+ Ajouter</button>
          </form>
          <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
            <span style="font-weight:600">Total Victor</span>
            <span style="font-size:24px;font-weight:800;color:var(--victor)" id="victor-total">0 â‚¬</span>
          </div>
        </div>
        <div class="card">
          <div class="card-title" style="color:var(--arthur)"><div class="ico">ğŸ‘¤</div>Arthur â€” Ajouter un gain</div>
          <form onsubmit="addGain(event,'arthur')">
            <div class="form-group"><label>Date</label><input type="date" id="a-date" required></div>
            <div class="form-group"><label>Montant (â‚¬)</label><input type="number" id="a-amount" placeholder="0.00" step="0.01" min="0" required></div>
            <div class="form-group"><label>Description</label><input type="text" id="a-desc" placeholder="Ex: Vente AirPods..."></div>
            <div class="form-group"><label>CatÃ©gorie</label><select id="a-cat"><option value="vente">Vente</option><option value="prestation">Prestation</option><option value="autre">Autre</option></select></div>
            <button type="submit" class="btn" style="background:var(--arthur)">+ Ajouter</button>
          </form>
          <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
            <span style="font-weight:600">Total Arthur</span>
            <span style="font-size:24px;font-weight:800;color:var(--arthur)" id="arthur-total">0 â‚¬</span>
          </div>
        </div>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <div class="card-title" style="margin-bottom:0"><div class="ico" style="display:inline">ğŸ“ˆ</div> Ã‰volution des gains</div>
          <select id="chartPeriod" onchange="drawChart()" style="width:auto;padding:9px 14px">
            <option value="7">7 jours</option><option value="30">30 jours</option><option value="all">Tout</option>
          </select>
        </div>
        <div class="chart-wrap"><canvas id="mainChart"></canvas></div>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div class="card-title" style="margin-bottom:0">ğŸ• Derniers gains</div>
          <input type="text" id="searchGains" placeholder="Rechercher..." onkeyup="renderGainsTable()" style="width:190px;padding:9px 13px">
        </div>
        <div class="tbl-wrap"><table>
          <thead><tr><th>Date</th><th>Personne</th><th>CatÃ©gorie</th><th>Description</th><th>Montant</th><th>Action</th></tr></thead>
          <tbody id="gains-tbody"></tbody>
        </table></div>
      </div>
    </div>

    <!-- TRANSACTIONS -->
    <div class="tab" id="tab-transactions">
      <div class="grid4">
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ›’</div><div class="stat-num" id="t-ca">0 â‚¬</div><div class="stat-lbl">CA Total</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ“ˆ</div><div class="stat-num" id="t-margin">0 â‚¬</div><div class="stat-lbl">Marge Totale</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ§®</div><div class="stat-num" id="t-count">0</div><div class="stat-lbl">Transactions</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">%</div><div class="stat-num" id="t-rate">0%</div><div class="stat-lbl">Taux de marge</div></div>
      </div>
      <div class="card">
        <div class="card-title">â• Nouvelle transaction</div>
        <form onsubmit="addTransaction(event)">
          <div class="grid3">
            <div class="form-group"><label>Personne</label><select id="tr-person"><option value="victor">Victor</option><option value="arthur">Arthur</option><option value="commun">Commun</option></select></div>
            <div class="form-group"><label>Produit</label><select id="tr-product" onchange="fillTransactionProduct()"><option value="">-- SÃ©lectionner --</option></select></div>
            <div class="form-group"><label>QuantitÃ©</label><input type="number" id="tr-qty" value="1" min="1" onchange="fillTransactionProduct()"></div>
            <div class="form-group"><label>Prix de vente (â‚¬)</label><input type="number" id="tr-price" step="0.01" placeholder="0.00" required></div>
            <div class="form-group"><label>CoÃ»t d'achat (â‚¬)</label><input type="number" id="tr-cost" step="0.01" placeholder="0.00" readonly style="opacity:.7"></div>
            <div class="form-group"><label>Date</label><input type="date" id="tr-date" required></div>
          </div>
          <div style="padding:12px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:14px;display:flex;gap:22px">
            <span>Marge unitaire : <strong id="tr-mu">0.00 â‚¬</strong></span>
            <span>Marge totale : <strong id="tr-mt">0.00 â‚¬</strong></span>
          </div>
          <button type="submit" class="btn success">âœ“ Valider la transaction</button>
        </form>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Historique</div>
        <div class="tbl-wrap"><table>
          <thead><tr><th>Date</th><th>Personne</th><th>Produit</th><th>QtÃ©</th><th>Prix vente</th><th>CoÃ»t</th><th>Marge</th><th>Action</th></tr></thead>
          <tbody id="trans-tbody"></tbody>
        </table></div>
      </div>
    </div>

    <!-- BOXES -->
    <div class="tab" id="tab-boxes">
      <div class="grid3">
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ“¦</div><div class="stat-num" id="b-total">0</div><div class="stat-lbl">Boxes crÃ©Ã©es</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ’¶</div><div class="stat-num" id="b-ca">0 â‚¬</div><div class="stat-lbl">CA Boxes</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ“ˆ</div><div class="stat-num" id="b-margin">0 â‚¬</div><div class="stat-lbl">Marge Boxes</div></div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“¦ CrÃ©er une box / lot</div>
        <form onsubmit="addBox(event)">
          <div class="grid2">
            <div class="form-group"><label>Nom de la box</label><input type="text" id="box-name" required placeholder="Ex: Pack Gaming"></div>
            <div class="form-group"><label>Prix de vente (â‚¬)</label><input type="number" id="box-price" step="0.01" required placeholder="0.00"></div>
            <div class="form-group"><label>Date</label><input type="date" id="box-date" required></div>
            <div class="form-group"><label>CoÃ»t total calculÃ©</label><input type="number" id="box-cost" readonly style="opacity:.7" placeholder="Auto"></div>
          </div>
          <div style="border:1px dashed var(--border);border-radius:var(--radius-sm);padding:16px;margin-bottom:14px">
            <h4 style="margin-bottom:12px">Produits dans la box</h4>
            <div id="box-products-list"></div>
            <div class="grid3" style="margin-top:12px">
              <select id="box-prod-sel"><option value="">-- Produit --</option></select>
              <input type="number" id="box-prod-qty" value="1" min="1" placeholder="QuantitÃ©">
              <button type="button" class="btn success sm" onclick="addProdToBox()">+ Ajouter</button>
            </div>
          </div>
          <div style="padding:12px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:14px;display:flex;gap:20px;flex-wrap:wrap">
            <span>CoÃ»t : <strong id="bx-cost">0 â‚¬</strong></span>
            <span>Vente : <strong id="bx-price">0 â‚¬</strong></span>
            <span>Marge : <strong id="bx-margin">0 â‚¬</strong></span>
            <span>Taux : <strong id="bx-rate">0%</strong></span>
          </div>
          <button type="submit" class="btn success">ğŸ’¾ CrÃ©er la box</button>
        </form>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“¦ Boxes crÃ©Ã©es</div>
        <div id="boxes-grid" class="grid-products"></div>
      </div>
    </div>

    <!-- PRODUCTS -->
    <div class="tab" id="tab-products">
      <div class="card">
        <div class="card-title">â• Ajouter un produit</div>
        <form onsubmit="addProduct(event)">
          <div class="grid3">
            <div class="form-group"><label>Nom</label><input type="text" id="p-name" required placeholder="Nom du produit"></div>
            <div class="form-group"><label>Prix de vente (â‚¬)</label><input type="number" id="p-price" step="0.01" required placeholder="0.00"></div>
            <div class="form-group"><label>Prix d'achat (â‚¬)</label><input type="number" id="p-cost" step="0.01" required placeholder="0.00"></div>
            <div class="form-group"><label>QuantitÃ© en stock</label><input type="number" id="p-qty" required placeholder="0"></div>
            <div class="form-group"><label>CatÃ©gorie</label><select id="p-cat"><option>Ã‰lectronique</option><option>VÃªtements</option><option>Alimentation</option><option>Maison</option><option>Sports</option><option>Livres</option><option>Jouets</option><option>Autre</option></select></div>
            <div class="form-group"><label>SKU (rÃ©fÃ©rence)</label><input type="text" id="p-sku" placeholder="Ex: SKU-001"></div>
          </div>
          <button type="submit" class="btn success">ğŸ’¾ Ajouter le produit</button>
        </form>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div class="card-title" style="margin-bottom:0">ğŸ›ï¸ Catalogue</div>
          <input type="text" id="searchProducts" placeholder="Rechercher..." onkeyup="renderProducts()" style="width:190px;padding:9px 13px">
        </div>
        <div id="products-grid" class="grid-products"></div>
      </div>
    </div>

    <!-- STOCK -->
    <div class="tab" id="tab-stock">
      <div class="grid4">
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ“¦</div><div class="stat-num" id="st-total">0</div><div class="stat-lbl">Produits</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ”¢</div><div class="stat-num" id="st-units">0</div><div class="stat-lbl">UnitÃ©s totales</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">âš ï¸</div><div class="stat-num" id="st-low" style="color:var(--warning)">0</div><div class="stat-lbl">Stock faible</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ’¶</div><div class="stat-num" id="st-value">0 â‚¬</div><div class="stat-lbl">Valeur stock</div></div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Ã‰tat des stocks</div>
        <div class="tbl-wrap"><table>
          <thead><tr><th>Produit</th><th>SKU</th><th>CatÃ©gorie</th><th>Prix vente</th><th>Prix achat</th><th>Stock</th><th>Valeur</th><th>Marge</th><th>Statut</th><th>Action</th></tr></thead>
          <tbody id="stock-tbody"></tbody>
        </table></div>
      </div>
    </div>

    <!-- CALENDAR -->
    <div class="tab" id="tab-calendar">
      <div class="card">
        <div class="card-title">ğŸ“… Ajouter un Ã©vÃ©nement</div>
        <form onsubmit="addEvent(event)">
          <div class="grid3">
            <div class="form-group"><label>Titre</label><input type="text" id="ev-title" required placeholder="Ex: Livraison client..."></div>
            <div class="form-group"><label>Date</label><input type="date" id="ev-date" required></div>
            <div class="form-group"><label>Heure</label><input type="text" id="ev-time" placeholder="14:30"></div>
            <div class="form-group"><label>Personne</label><select id="ev-person"><option value="commun">Commun</option><option value="victor">Victor</option><option value="arthur">Arthur</option></select></div>
            <div class="form-group"><label>Type</label><select id="ev-type"><option value="rdv">Rendez-vous</option><option value="livraison">Livraison</option><option value="reunion">RÃ©union</option><option value="autre">Autre</option></select></div>
            <div style="display:flex;align-items:flex-end"><button type="submit" class="btn">+ Ajouter</button></div>
          </div>
        </form>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <div class="card-title" style="margin-bottom:0">ğŸ“… <span id="cal-month-title">Calendrier</span></div>
          <div style="display:flex;gap:9px">
            <button class="btn ghost sm" onclick="prevMonth()">â€¹</button>
            <button class="btn ghost sm" onclick="nextMonth()">â€º</button>
          </div>
        </div>
        <div class="cal-header">
          <div class="cal-day-name">Lun</div><div class="cal-day-name">Mar</div><div class="cal-day-name">Mer</div>
          <div class="cal-day-name">Jeu</div><div class="cal-day-name">Ven</div><div class="cal-day-name">Sam</div><div class="cal-day-name">Dim</div>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>
    </div>

    <!-- STATS -->
    <div class="tab" id="tab-stats">
      <div class="grid4">
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ’¶</div><div class="stat-num" id="st2-total">0 â‚¬</div><div class="stat-lbl">Total gains</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ‘¤</div><div class="stat-num" id="st2-victor" style="color:var(--victor)">0 â‚¬</div><div class="stat-lbl">Victor</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ‘¤</div><div class="stat-num" id="st2-arthur" style="color:var(--arthur)">0 â‚¬</div><div class="stat-lbl">Arthur</div></div>
        <div class="stat-card"><div class="stat-icon" style="font-size:24px">ğŸ“Š</div><div class="stat-num" id="st2-avg">0 â‚¬</div><div class="stat-lbl">Moy/jour</div></div>
      </div>
      <div class="grid2">
        <div class="card"><div class="card-title">ğŸ¥§ RÃ©partition</div><div class="chart-wrap"><canvas id="pieChart"></canvas></div></div>
        <div class="card"><div class="card-title">ğŸ“Š Par mois</div><div class="chart-wrap"><canvas id="barChart"></canvas></div></div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ† Objectifs mensuels</div>
        <div class="grid2">
          <div>
            <h4 style="margin-bottom:10px">Victor â€” Objectif 2 000 â‚¬</h4>
            <div class="stock-bar" style="height:18px"><div class="stock-fill" id="prog-victor" style="width:0%;background:var(--victor)"></div></div>
            <p id="goal-victor" style="margin-top:7px;font-size:13px">0 â‚¬ / 2000 â‚¬</p>
          </div>
          <div>
            <h4 style="margin-bottom:10px">Arthur â€” Objectif 2 000 â‚¬</h4>
            <div class="stock-bar" style="height:18px"><div class="stock-fill" id="prog-arthur" style="width:0%;background:var(--arthur)"></div></div>
            <p id="goal-arthur" style="margin-top:7px;font-size:13px">0 â‚¬ / 2000 â‚¬</p>
          </div>
        </div>
      </div>
    </div>

    <!-- CLIENTS -->
    <div class="tab" id="tab-clients">
      <div class="card">
        <div class="card-title">ğŸ‘¤ Ajouter un client</div>
        <form onsubmit="addClient(event)">
          <div class="grid3">
            <div class="form-group"><label>Nom complet</label><input type="text" id="cl-name" required></div>
            <div class="form-group"><label>Email</label><input type="email" id="cl-email"></div>
            <div class="form-group"><label>TÃ©lÃ©phone</label><input type="text" id="cl-phone"></div>
            <div class="form-group"><label>Entreprise</label><input type="text" id="cl-company"></div>
            <div class="form-group"><label>Type</label><select id="cl-type"><option value="particulier">Particulier</option><option value="professionnel">Professionnel</option></select></div>
            <div style="display:flex;align-items:flex-end"><button type="submit" class="btn success">+ Ajouter</button></div>
          </div>
        </form>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div class="card-title" style="margin-bottom:0">ğŸ‘¥ Liste clients</div>
          <input type="text" id="searchClients" placeholder="Rechercher..." onkeyup="renderClients()" style="width:190px;padding:9px 13px">
        </div>
        <div id="clients-grid" class="grid-products"></div>
      </div>
    </div>

    <!-- FILES -->
    <div class="tab" id="tab-files">
      <div class="card">
        <div class="card-title">â˜ï¸ Uploader des fichiers</div>
        <div class="upload-zone" id="uploadZone">
          <div style="font-size:44px;margin-bottom:12px">â˜ï¸</div>
          <p style="font-size:15px;font-weight:600;margin-bottom:5px">Glissez vos fichiers ici</p>
          <p style="color:var(--text-light);font-size:13px">Factures PDF, photos de produits, reÃ§us...</p>
          <input type="file" id="fileInput" multiple style="display:none" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx">
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“ Fichiers stockÃ©s <span class="badge b-info" id="files-count">0</span></div>
        <div id="files-list"></div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"><span id="toastIco">âœ“</span><span id="toastMsg"></span></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARGEMENT SUPABASE + CHART.JS via CDN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function loadScripts(){
  const scripts = [
    'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js',
    'https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js'
  ];
  let loaded = 0;
  scripts.forEach(src => {
    const s = document.createElement('script');
    s.src = src;
    s.onload = () => { loaded++; if(loaded === scripts.length) initApp(); };
    s.onerror = () => showNetworkError();
    document.head.appendChild(s);
  });
})();

function showNetworkError(){
  document.getElementById('loginWrap').innerHTML = `
    <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1e3a8a,#065f46);padding:20px">
      <div style="background:#fff;border-radius:20px;padding:40px;max-width:480px;text-align:center">
        <div style="font-size:52px;margin-bottom:16px">ğŸŒ</div>
        <h2 style="color:#ef4444;margin-bottom:14px">Connexion Internet requise</h2>
        <p style="color:#64748b;margin-bottom:20px">Ce dashboard se connecte Ã  Supabase et nÃ©cessite Internet.</p>
        <div style="background:#f8fafc;border-radius:12px;padding:16px;text-align:left;margin-bottom:20px;font-size:14px">
          <strong>âœ… VÃ©rifiez que vous Ãªtes bien connectÃ©</strong><br><br>
          Si le problÃ¨me persiste, ouvrez le fichier depuis un serveur :<br>
          â€¢ Glissez le fichier sur <a href="https://codesandbox.io" target="_blank" style="color:#2563eb">codesandbox.io</a><br>
          â€¢ Ou utilisez VS Code + extension <strong>Live Server</strong>
        </div>
        <button onclick="location.reload()" style="background:#2563eb;color:#fff;border:none;padding:14px 28px;border-radius:12px;cursor:pointer;font-size:15px;font-weight:600">â†º RÃ©essayer</button>
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPA_URL = 'https://xqhgmtxqfeooaeviqdbg.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxaGdtdHhxZmVvb2FldmlxZGJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMDc5MzUsImV4cCI6MjA4Njc4MzkzNX0.7kosR0wE0mwxAP2HX-t3DYQytJ0C41_uIBP350poMbo';
const USERS_CFG = { victor:{email:'victor@gestionpro.fr',color:'#2563eb'}, arthur:{email:'arthur@gestionpro.fr',color:'#10b981'} };
const TODAY = new Date().toISOString().split('T')[0];
const MONTHS = ['Janvier','FÃ©vrier','Mars','Avril','Mai','Juin','Juillet','AoÃ»t','Septembre','Octobre','Novembre','DÃ©cembre'];

let db, currentUser=null, selectedPerson=null;
let gains=[],products=[],transactions=[],boxes=[],clients=[],events=[],files=[];
let mainChart,pieChart2,barChart2;
let calMonth=new Date().getMonth(), calYear=new Date().getFullYear();
let boxProds=[];

async function initApp(){
  db = window.supabase.createClient(SUPA_URL, SUPA_KEY);
  setToday();
  initCharts();
  initUpload();
  const {data:{session}} = await db.auth.getSession();
  if(session){ currentUser=session.user; showApp(session.user.email.split('@')[0]); await loadAll(); }
}

function setToday(){
  ['v-date','a-date','tr-date','box-date','ev-date'].forEach(id=>{const e=el(id);if(e)e.value=TODAY;});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectUser(who){
  selectedPerson=who;
  document.querySelectorAll('.user-btn').forEach(b=>b.classList.remove('selected'));
  el('btn-'+who).classList.add('selected');
}

async function doLogin(){
  if(!selectedPerson){toast('Choisissez Victor ou Arthur','w');return;}
  const pwd=el('loginPwd').value.trim();
  if(pwd.length<6){toast('Mot de passe : 6 caractÃ¨res minimum','w');return;}
  const btn=el('loginBtn');
  btn.disabled=true; btn.textContent='â³ Connexion...';
  try {
    let {data,error}=await db.auth.signInWithPassword({email:USERS_CFG[selectedPerson].email,password:pwd});
    if(error){
      const {data:d2,error:e2}=await db.auth.signUp({email:USERS_CFG[selectedPerson].email,password:pwd,options:{data:{username:selectedPerson}}});
      if(e2){
        if(e2.status===500||e2.message?.includes('email')){showEmailGuide();throw new Error('DÃ©sactivez la confirmation email (voir les instructions)');}
        throw e2;
      }
      if(d2?.user&&!d2.session){showEmailGuide();throw new Error('Activez votre compte ou dÃ©sactivez la confirmation email');}
      data=d2; toast('Compte crÃ©Ã© ! Bienvenue ğŸ‰','s');
    }
    if(!data?.user) throw new Error('Connexion impossible');
    currentUser=data.user;
    showApp(selectedPerson);
    await loadAll();
    toast('ConnectÃ© âœ“','s');
  } catch(e){ toast('Erreur : '+e.message,'e'); }
  finally{ btn.disabled=false; btn.textContent='âœ Se connecter'; }
}

function showEmailGuide(){
  el('loginMsg').innerHTML=`<span style="color:#f59e0b;font-weight:600">âš  DÃ©sactivez la confirmation email :<br>
  <a href="https://supabase.com/dashboard/project/xqhgmtxqfeooaeviqdbg/auth/providers" target="_blank" style="color:#2563eb">
  Supabase â†’ Auth â†’ Providers â†’ Email â†’ dÃ©cochez "Confirm email" â†’ Save</a></span>`;
}

async function doLogout(){
  await db.auth.signOut(); currentUser=null;
  el('app').classList.remove('active');
  el('loginWrap').style.display='flex';
  toast('DÃ©connectÃ©','i');
}

function showApp(who){
  el('loginWrap').style.display='none';
  el('app').classList.add('active');
  el('userPill').style.background=USERS_CFG[who]?.color||'#2563eb';
  el('userLabel').textContent=who.charAt(0).toUpperCase()+who.slice(1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSync(state,txt){
  const b=el('syncBadge'),i=el('syncIco'),s=el('syncText');
  b.className='sync-badge '+state; s.textContent=txt;
  i.textContent=state==='syncing'?'â³':state==='synced'?'â˜':'âš ';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAll(){
  setSync('syncing','Chargement...');
  try {
    const [g,p,tr,bx,cl,ev,fi]=await Promise.all([
      db.from('gains').select('*').order('date',{ascending:false}),
      db.from('products').select('*').order('created_at',{ascending:false}),
      db.from('transactions').select('*').order('date',{ascending:false}),
      db.from('boxes').select('*').order('date',{ascending:false}),
      db.from('clients').select('*').order('created_at',{ascending:false}),
      db.from('events').select('*').order('date',{ascending:true}),
      db.from('files').select('*').order('created_at',{ascending:false})
    ]);
    const hasErr=[g,p,tr,bx,cl,ev,fi].some(r=>r.error&&(r.error.status===401||r.error.status===403||r.error.code==='42P01'));
    if(hasErr){setSync('error','Tables manquantes');toast('Lancez le SQL dans Supabase !','w');return;}
    gains=g.data||[]; products=p.data||[]; transactions=tr.data||[];
    boxes=bx.data||[]; clients=cl.data||[]; events=ev.data||[]; files=fi.data||[];
    renderAll();
    setSync('synced','SynchronisÃ© âœ“');
  } catch(e){ setSync('error','Erreur'); toast('Erreur : '+e.message,'e'); }
}

function renderAll(){
  updateDashStats(); renderGainsTable(); drawChart(); renderProducts(); updateStockStats();
  renderStockTable(); renderTransactions(); renderBoxesList(); updateBoxesStats();
  renderCalendar(); renderClients(); renderFiles(); updateStatsTab(); fillProductSelects();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateDashStats(){
  const vT=gains.filter(g=>g.person==='victor').reduce((s,g)=>s+Number(g.amount),0);
  const aT=gains.filter(g=>g.person==='arthur').reduce((s,g)=>s+Number(g.amount),0);
  const now=new Date();
  const mT=gains.filter(g=>{const d=new Date(g.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();}).reduce((s,g)=>s+Number(g.amount),0);
  el('s-total').textContent=fmt(vT+aT); el('s-victor').textContent=fmt(vT);
  el('s-arthur').textContent=fmt(aT); el('s-month').textContent=fmt(mT);
  el('victor-total').textContent=fmt(vT); el('arthur-total').textContent=fmt(aT);
}

function renderGainsTable(){
  const q=(el('searchGains').value||'').toLowerCase();
  const all=[...gains].filter(g=>!q||(g.description||'').toLowerCase().includes(q)||g.person.includes(q)||String(g.amount).includes(q)).slice(0,30);
  el('gains-tbody').innerHTML=all.map(g=>`<tr>
    <td>${g.date}</td>
    <td><span class="badge ${g.person==='victor'?'b-victor':'b-arthur'}">${g.person}</span></td>
    <td><span class="badge b-info">${g.category||'autre'}</span></td>
    <td>${g.description||'-'}</td>
    <td><strong>${fmt(g.amount)}</strong></td>
    <td><button class="btn danger sm" onclick="deleteGain('${g.id}')">ğŸ—‘</button></td>
  </tr>`).join('');
}

async function addGain(e,person){
  e.preventDefault();
  const pf=person==='victor'?'v':'a';
  const row={date:el(pf+'-date').value,amount:Number(el(pf+'-amount').value),description:el(pf+'-desc').value||'Gain',person,category:el(pf+'-cat').value};
  setSync('syncing','Enregistrement...');
  try {
    const {data,error}=await db.from('gains').insert([row]).select();
    if(error) throw error;
    gains.unshift(data[0]); e.target.reset(); el(pf+'-date').value=TODAY;
    renderAll(); toast(`${fmt(row.amount)} ajoutÃ© âœ“`,'s');
  } catch(err){toast('Erreur : '+err.message,'e');setSync('error','Erreur');}
}

async function deleteGain(id){
  if(!confirm('Supprimer ce gain ?')) return;
  await db.from('gains').delete().eq('id',id);
  gains=gains.filter(g=>g.id!==id); renderAll(); toast('SupprimÃ©','w');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRODUCTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addProduct(e){
  e.preventDefault();
  const row={name:el('p-name').value,price:Number(el('p-price').value),cost:Number(el('p-cost').value),quantity:Number(el('p-qty').value),category:el('p-cat').value,sku:el('p-sku').value||`SKU-${Date.now()}`};
  const {data,error}=await db.from('products').insert([row]).select();
  if(error){toast('Erreur : '+error.message,'e');return;}
  products.unshift(data[0]); e.target.reset(); renderAll(); toast(`"${row.name}" ajoutÃ© âœ“`,'s');
}

function renderProducts(){
  const q=(el('searchProducts')?.value||'').toLowerCase();
  const f=products.filter(p=>!q||p.name.toLowerCase().includes(q)||(p.sku||'').toLowerCase().includes(q));
  el('products-grid').innerHTML=f.map(p=>`<div class="prod-card">
    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:9px">
      <h3 style="font-size:15px">${p.name}</h3><span class="badge b-info">${p.category||'-'}</span>
    </div>
    <div style="font-size:22px;font-weight:800;color:var(--accent);margin:9px 0">${fmt(p.price)}</div>
    <div class="stock-bar"><div class="stock-fill" style="width:${Math.min(100,p.quantity)}%"></div></div>
    <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:12px">
      <span>ğŸ“¦ ${p.quantity} unitÃ©s</span><span>Achat: ${fmt(p.cost)}</span>
    </div>
    <div style="font-size:12px;margin-bottom:12px">Marge: <span class="badge b-success">+${fmt(p.price-(p.cost||0))}</span></div>
    <div style="display:flex;gap:7px">
      <button class="btn sm" onclick="editProductQty('${p.id}',${p.quantity})" style="flex:1;background:var(--warning)">âœï¸</button>
      <button class="btn danger sm" onclick="deleteProduct('${p.id}')" style="flex:1">ğŸ—‘</button>
    </div>
  </div>`).join('');
  el('nb-products').textContent=products.length;
  el('nb-products').style.display=products.length>0?'inline':'none';
  fillProductSelects();
}

async function deleteProduct(id){
  if(!confirm('Supprimer ce produit ?')) return;
  await db.from('products').delete().eq('id',id);
  products=products.filter(p=>p.id!==id); renderAll(); toast('Produit supprimÃ©','w');
}

async function editProductQty(id,current){
  const q=prompt('Nouvelle quantitÃ©:',current); if(q===null) return;
  await db.from('products').update({quantity:Number(q)}).eq('id',id);
  products.find(p=>p.id===id).quantity=Number(q); renderAll(); toast('Stock mis Ã  jour âœ“','s');
}

function updateStockStats(){
  const low=products.filter(p=>p.quantity<10).length;
  el('st-total').textContent=products.length;
  el('st-units').textContent=products.reduce((s,p)=>s+p.quantity,0);
  el('st-low').textContent=low;
  el('st-value').textContent=fmt(products.reduce((s,p)=>s+(p.price*p.quantity),0));
  el('nb-lowstock').style.display=low>0?'inline':'none';
}

function renderStockTable(){
  el('stock-tbody').innerHTML=products.map(p=>`<tr>
    <td><strong>${p.name}</strong></td><td><span class="badge b-info">${p.sku||'-'}</span></td>
    <td>${p.category||'-'}</td><td>${fmt(p.price)}</td><td>${fmt(p.cost)}</td>
    <td><span class="badge ${p.quantity<5?'b-danger':p.quantity<10?'b-warning':'b-success'}">${p.quantity}</span></td>
    <td>${fmt(p.price*p.quantity)}</td><td><span class="badge b-info">+${fmt(p.price-(p.cost||0))}</span></td>
    <td>${p.quantity<5?'<span class="badge b-danger">Critique</span>':p.quantity<10?'<span class="badge b-warning">Faible</span>':'<span class="badge b-success">OK</span>'}</td>
    <td><div style="display:flex;gap:5px">
      <button class="btn sm success" onclick="stockDelta('${p.id}',1)">+</button>
      <button class="btn sm warning" onclick="stockDelta('${p.id}',-1)">-</button>
    </div></td>
  </tr>`).join('');
}

async function stockDelta(id,delta){
  const p=products.find(x=>x.id===id); if(!p) return;
  const nq=Math.max(0,p.quantity+delta);
  await db.from('products').update({quantity:nq}).eq('id',id);
  p.quantity=nq; renderAll(); toast(`Stock ${delta>0?'+1':'-1'} âœ“`,'s');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fillProductSelects(){
  const opts='<option value="">-- SÃ©lectionner --</option>'+products.map(p=>`<option value="${p.id}" data-price="${p.price}" data-cost="${p.cost}">${p.name} (${p.quantity} en stock)</option>`).join('');
  ['tr-product','box-prod-sel'].forEach(id=>{const e=document.getElementById(id);if(e)e.innerHTML=opts;});
}

function fillTransactionProduct(){
  const sel=el('tr-product'),opt=sel.options[sel.selectedIndex];
  const price=Number(opt.dataset.price||0),cost=Number(opt.dataset.cost||0),qty=Number(el('tr-qty').value)||1;
  el('tr-price').value=price.toFixed(2); el('tr-cost').value=cost.toFixed(2);
  el('tr-mu').textContent=fmt(price-cost); el('tr-mt').textContent=fmt((price-cost)*qty);
}

async function addTransaction(e){
  e.preventDefault();
  const prod=products.find(p=>p.id===el('tr-product').value);
  if(!prod){toast('Choisissez un produit','w');return;}
  const qty=Number(el('tr-qty').value),price=Number(el('tr-price').value),cost=Number(el('tr-cost').value);
  if(prod.quantity<qty){toast('Stock insuffisant !','e');return;}
  const row={person:el('tr-person').value,product_name:prod.name,quantity:qty,price,cost,margin:(price-cost)*qty,date:el('tr-date').value};
  setSync('syncing','Enregistrement...');
  try {
    const {data,error}=await db.from('transactions').insert([row]).select();
    if(error) throw error;
    transactions.unshift(data[0]);
    const nq=prod.quantity-qty;
    await db.from('products').update({quantity:nq}).eq('id',prod.id); prod.quantity=nq;
    const gainRow={date:row.date,amount:price*qty,description:`Vente: ${prod.name} x${qty}`,person:row.person==='commun'?'victor':row.person,category:'vente'};
    await db.from('gains').insert([gainRow]);
    await loadAll(); e.target.reset(); setToday();
    toast(`Transaction OK ! Marge: ${fmt(row.margin)}`,'s');
  } catch(err){toast('Erreur : '+err.message,'e');}
}

function renderTransactions(){
  const total=transactions.reduce((s,t)=>s+Number(t.price)*Number(t.quantity),0);
  const margin=transactions.reduce((s,t)=>s+Number(t.margin),0);
  el('t-ca').textContent=fmt(total); el('t-margin').textContent=fmt(margin);
  el('t-count').textContent=transactions.length;
  el('t-rate').textContent=total>0?(margin/total*100).toFixed(1)+'%':'0%';
  el('nb-transactions').textContent=transactions.length;
  el('nb-transactions').style.display=transactions.length>0?'inline':'none';
  el('trans-tbody').innerHTML=transactions.map(t=>`<tr>
    <td>${t.date}</td>
    <td><span class="badge ${t.person==='victor'?'b-victor':'b-arthur'}">${t.person}</span></td>
    <td>${t.product_name}</td><td>${t.quantity}</td><td>${fmt(t.price)}</td><td>${fmt(t.cost)}</td>
    <td><span class="badge ${Number(t.margin)>0?'b-success':'b-danger'}">${fmt(t.margin)}</span></td>
    <td><button class="btn danger sm" onclick="deleteTransaction('${t.id}')">ğŸ—‘</button></td>
  </tr>`).join('');
}
function updateTransStats(){renderTransactions();}

async function deleteTransaction(id){
  if(!confirm('Supprimer ?')) return;
  await db.from('transactions').delete().eq('id',id);
  transactions=transactions.filter(t=>t.id!==id); renderAll(); toast('Transaction supprimÃ©e','w');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOXES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addProdToBox(){
  const sel=el('box-prod-sel'),id=sel.value;
  if(!id){toast('Choisissez un produit','w');return;}
  const qty=Number(el('box-prod-qty').value)||1,prod=products.find(p=>p.id===id);
  if(!prod) return;
  if(prod.quantity<qty){toast('Stock insuffisant','e');return;}
  boxProds.push({productId:id,name:prod.name,quantity:qty,price:prod.price,cost:prod.cost});
  refreshBoxUI();
}

function refreshBoxUI(){
  el('box-products-list').innerHTML=boxProds.map((p,i)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:9px;border-bottom:1px solid var(--border)">
    <span><strong>${p.name}</strong> x${p.quantity}</span><span>${fmt(p.cost*p.quantity)}</span>
    <button class="btn danger sm" onclick="removeProdFromBox(${i})">âœ•</button>
  </div>`).join('');
  const tc=boxProds.reduce((s,p)=>s+p.cost*p.quantity,0);
  const tp=boxProds.reduce((s,p)=>s+p.price*p.quantity,0);
  const mg=tp-tc,rate=tp>0?(mg/tp*100):0;
  el('box-cost').value=tc.toFixed(2);
  el('bx-cost').textContent=fmt(tc); el('bx-price').textContent=fmt(tp);
  el('bx-margin').textContent=fmt(mg); el('bx-rate').textContent=rate.toFixed(1)+'%';
}

function removeProdFromBox(i){boxProds.splice(i,1);refreshBoxUI();}

async function addBox(e){
  e.preventDefault();
  if(!boxProds.length){toast('Ajoutez au moins un produit','w');return;}
  const price=Number(el('box-price').value),cost=Number(el('box-cost').value);
  const row={name:el('box-name').value,price,cost,products:JSON.stringify(boxProds),date:el('box-date').value};
  setSync('syncing','CrÃ©ation...');
  try {
    const {data,error}=await db.from('boxes').insert([row]).select();
    if(error) throw error;
    boxes.unshift(data[0]);
    for(const p of boxProds){
      const prod=products.find(x=>x.id===p.productId);
      if(prod){prod.quantity-=p.quantity;await db.from('products').update({quantity:prod.quantity}).eq('id',p.productId);}
    }
    boxProds=[];refreshBoxUI();e.target.reset();setToday();renderAll();toast(`Box "${row.name}" crÃ©Ã©e âœ“`,'s');
  } catch(err){toast('Erreur : '+err.message,'e');}
}

function renderBoxesList(){
  el('boxes-grid').innerHTML=boxes.map(b=>{
    const prods=typeof b.products==='string'?JSON.parse(b.products):b.products;
    const mg=b.price-b.cost;
    return `<div class="prod-card">
      <h3 style="color:var(--accent);margin-bottom:10px">${b.name}</h3>
      <div style="font-size:21px;font-weight:800;margin-bottom:9px">${fmt(b.price)}</div>
      <div class="stock-bar"><div class="stock-fill" style="width:${Math.min(100,(mg/b.price)*200)}%"></div></div>
      <p style="font-size:13px">CoÃ»t : ${fmt(b.cost)}</p>
      <p style="font-size:13px">Marge : <span class="badge b-success">+${fmt(mg)}</span></p>
      <p style="font-size:13px">Produits : ${(prods||[]).length}</p>
      <p style="font-size:12px;color:var(--text-light)">${b.date}</p>
    </div>`;
  }).join('');
}

function updateBoxesStats(){
  el('b-total').textContent=boxes.length;
  el('b-ca').textContent=fmt(boxes.reduce((s,b)=>s+b.price,0));
  el('b-margin').textContent=fmt(boxes.reduce((s,b)=>s+(b.price-b.cost),0));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCalendar(){
  el('cal-month-title').textContent=`${MONTHS[calMonth]} ${calYear}`;
  const first=new Date(calYear,calMonth,1).getDay();
  const offset=(first===0)?6:first-1;
  const days=new Date(calYear,calMonth+1,0).getDate();
  const today=new Date();
  let html='';
  for(let i=0;i<offset;i++) html+='<div></div>';
  for(let d=1;d<=days;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayEvs=events.filter(ev=>ev.date===ds);
    const isToday=d===today.getDate()&&calMonth===today.getMonth()&&calYear===today.getFullYear();
    html+=`<div class="cal-day ${isToday?'today':''}" onclick="showDayAlert('${ds}')">
      <div class="cal-num">${d}</div>
      ${dayEvs.slice(0,2).map(ev=>`<div class="cal-event">${ev.time?ev.time+' ':''} ${ev.title}</div>`).join('')}
      ${dayEvs.length>2?`<div style="font-size:10px;color:var(--accent)">+${dayEvs.length-2}</div>`:''}
    </div>`;
  }
  el('calGrid').innerHTML=html;
}

function showDayAlert(ds){
  const dayEvs=events.filter(ev=>ev.date===ds);
  if(!dayEvs.length){toast('Aucun Ã©vÃ©nement','i');return;}
  alert(`Ã‰vÃ©nements du ${ds}:\n`+dayEvs.map(ev=>`â€¢ ${ev.time||'?'} - ${ev.title} (${ev.person})`).join('\n'));
}

function prevMonth(){calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderCalendar();}
function nextMonth(){calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderCalendar();}

async function addEvent(e){
  e.preventDefault();
  const row={title:el('ev-title').value,date:el('ev-date').value,time:el('ev-time').value,person:el('ev-person').value,type:el('ev-type').value};
  const {data,error}=await db.from('events').insert([row]).select();
  if(error){toast('Erreur : '+error.message,'e');return;}
  events.push(data[0]); events.sort((a,b)=>a.date.localeCompare(b.date));
  e.target.reset(); el('ev-date').value=TODAY; renderCalendar(); toast('Ã‰vÃ©nement ajoutÃ© âœ“','s');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStatsTab(){
  const vT=gains.filter(g=>g.person==='victor').reduce((s,g)=>s+Number(g.amount),0);
  const aT=gains.filter(g=>g.person==='arthur').reduce((s,g)=>s+Number(g.amount),0);
  const total=vT+aT,days=new Set(gains.map(g=>g.date)).size;
  el('st2-total').textContent=fmt(total); el('st2-victor').textContent=fmt(vT);
  el('st2-arthur').textContent=fmt(aT); el('st2-avg').textContent=days?fmt(total/days):'0 â‚¬';
  const now=new Date();
  const vm=gains.filter(g=>g.person==='victor'&&new Date(g.date).getMonth()===now.getMonth()&&new Date(g.date).getFullYear()===now.getFullYear()).reduce((s,g)=>s+Number(g.amount),0);
  const am=gains.filter(g=>g.person==='arthur'&&new Date(g.date).getMonth()===now.getMonth()&&new Date(g.date).getFullYear()===now.getFullYear()).reduce((s,g)=>s+Number(g.amount),0);
  el('prog-victor').style.width=Math.min(100,(vm/2000*100))+'%'; el('goal-victor').textContent=`${fmt(vm)} / 2000 â‚¬`;
  el('prog-arthur').style.width=Math.min(100,(am/2000*100))+'%'; el('goal-arthur').textContent=`${fmt(am)} / 2000 â‚¬`;
  if(pieChart2){pieChart2.data.datasets[0].data=[vT,aT];pieChart2.update();}
  if(barChart2){
    const months=[],data=[];
    for(let i=5;i>=0;i--){
      const d=new Date();d.setMonth(d.getMonth()-i);
      const m=d.getMonth(),y=d.getFullYear();
      months.push(d.toLocaleDateString('fr-FR',{month:'short'}));
      data.push(gains.filter(g=>new Date(g.date).getMonth()===m&&new Date(g.date).getFullYear()===y).reduce((s,g)=>s+Number(g.amount),0));
    }
    barChart2.data.labels=months;barChart2.data.datasets[0].data=data;barChart2.update();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addClient(e){
  e.preventDefault();
  const row={name:el('cl-name').value,email:el('cl-email').value,phone:el('cl-phone').value,company:el('cl-company').value,type:el('cl-type').value};
  const {data,error}=await db.from('clients').insert([row]).select();
  if(error){toast('Erreur : '+error.message,'e');return;}
  clients.unshift(data[0]);e.target.reset();renderClients();toast(`"${row.name}" ajoutÃ© âœ“`,'s');
}

function renderClients(){
  const q=(el('searchClients')?.value||'').toLowerCase();
  const f=clients.filter(c=>!q||c.name.toLowerCase().includes(q)||(c.email||'').toLowerCase().includes(q));
  el('clients-grid').innerHTML=f.map(c=>`<div class="prod-card">
    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
      <h3 style="font-size:15px">ğŸ‘¤ ${c.name}</h3>
      <button class="btn danger sm" onclick="deleteClient('${c.id}')">âœ•</button>
    </div>
    <p style="font-size:13px;margin:5px 0">ğŸ“§ ${c.email||'Non renseignÃ©'}</p>
    <p style="font-size:13px;margin:5px 0">ğŸ“ ${c.phone||'Non renseignÃ©'}</p>
    <p style="font-size:13px;margin:5px 0">ğŸ¢ ${c.company||'Non renseignÃ©'}</p>
    <span class="badge b-info" style="margin-top:7px">${c.type||'particulier'}</span>
  </div>`).join('');
}

async function deleteClient(id){
  await db.from('clients').delete().eq('id',id);
  clients=clients.filter(c=>c.id!==id);renderClients();toast('Client supprimÃ©','w');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initUpload(){
  const zone=el('uploadZone'),input=el('fileInput');
  zone.addEventListener('click',()=>input.click());
  zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('drag');});
  zone.addEventListener('dragleave',()=>zone.classList.remove('drag'));
  zone.addEventListener('drop',async e=>{e.preventDefault();zone.classList.remove('drag');await uploadFiles(Array.from(e.dataTransfer.files));});
  input.addEventListener('change',async e=>{await uploadFiles(Array.from(e.target.files));input.value='';});
}

async function uploadFiles(fileList){
  for(const file of fileList){
    const ext=file.name.split('.').pop();
    const path=`${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
    setSync('syncing',`Upload ${file.name}...`);
    try {
      const {error:upErr}=await db.storage.from('uploads').upload(path,file);
      if(upErr) throw upErr;
      const {data:{publicUrl}}=db.storage.from('uploads').getPublicUrl(path);
      const {data,error:dbErr}=await db.from('files').insert([{name:file.name,type:file.type,size:file.size,url:publicUrl}]).select();
      if(dbErr) throw dbErr;
      files.unshift(data[0]);renderFiles();toast(`${file.name} uploadÃ© âœ“`,'s');
    } catch(err){toast('Erreur upload : '+err.message,'e');}
  }
  setSync('synced','SynchronisÃ©');
}

function renderFiles(){
  el('files-count').textContent=files.length;
  el('files-list').innerHTML=files.map(f=>`<div class="file-item">
    <div style="display:flex;align-items:center;gap:12px">
      ${f.type.startsWith('image/')?`<img src="${f.url}" class="file-thumb" alt="${f.name}">`:'<div class="file-icon-box">ğŸ“„</div>'}
      <div>
        <div style="font-weight:600;font-size:13px">${f.name}</div>
        <div style="font-size:11px;color:var(--text-light)">${f.size?((f.size/1024).toFixed(1)+' KB'):''} â€” ${new Date(f.created_at).toLocaleDateString('fr-FR')}</div>
      </div>
    </div>
    <div style="display:flex;gap:7px">
      <button class="btn sm" onclick="window.open('${f.url}','_blank')">ğŸ‘ Voir</button>
      <a href="${f.url}" download class="btn sm success">â¬‡</a>
      <button class="btn danger sm" onclick="deleteFile('${f.id}','${f.url}')">ğŸ—‘</button>
    </div>
  </div>`).join('');
}

async function deleteFile(id,url){
  if(!confirm('Supprimer ce fichier ?')) return;
  const path=url.split('/uploads/')[1];
  await db.storage.from('uploads').remove([path]);
  await db.from('files').delete().eq('id',id);
  files=files.filter(f=>f.id!==id);renderFiles();toast('Fichier supprimÃ©','w');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCharts(){
  const ctx1=el('mainChart');
  if(ctx1) mainChart=new Chart(ctx1,{type:'line',data:{labels:[],datasets:[
    {label:'Victor',data:[],borderColor:'#2563eb',backgroundColor:'rgba(37,99,235,.05)',fill:true,tension:.4,borderWidth:3,pointRadius:4},
    {label:'Arthur',data:[],borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.05)',fill:true,tension:.4,borderWidth:3,pointRadius:4}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}});
  const ctx2=el('pieChart');
  if(ctx2) pieChart2=new Chart(ctx2,{type:'doughnut',data:{labels:['Victor','Arthur'],datasets:[{data:[0,0],backgroundColor:['#2563eb','#10b981'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}});
  const ctx3=el('barChart');
  if(ctx3) barChart2=new Chart(ctx3,{type:'bar',data:{labels:[],datasets:[{label:'Gains',data:[],backgroundColor:'#2563eb',borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
}

function drawChart(){
  if(!mainChart) return;
  const period=el('chartPeriod')?.value||'7';
  const now=new Date(),vMap={},aMap={},allDates=new Set();
  gains.forEach(g=>{
    const d=new Date(g.date),diff=(now-d)/86400000;
    if(period!=='all'&&diff>Number(period)) return;
    const key=d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'});
    allDates.add(key);
    if(g.person==='victor') vMap[key]=(vMap[key]||0)+Number(g.amount);
    else aMap[key]=(aMap[key]||0)+Number(g.amount);
  });
  const labels=Array.from(allDates);
  mainChart.data.labels=labels;
  mainChart.data.datasets[0].data=labels.map(k=>vMap[k]||0);
  mainChart.data.datasets[1].data=labels.map(k=>aMap[k]||0);
  mainChart.update();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TITLES={dashboard:'Tableau de bord',transactions:'Transactions',boxes:'Boxes / Lots',products:'Produits',stock:'Stocks',calendar:'Calendrier',stats:'Statistiques',clients:'Clients',files:'Fichiers Cloud'};

function goTab(name,navEl){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el('tab-'+name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(navEl) navEl.classList.add('active');
  el('pageTitle').textContent=TITLES[name]||name;
  closeSidebar();
  if(name==='stats') updateStatsTab();
  if(name==='calendar') renderCalendar();
  if(name==='files') renderFiles();
}

function toggleSidebar(){el('sidebar').classList.toggle('open');el('overlay').classList.toggle('active');}
function closeSidebar(){el('sidebar').classList.remove('open');el('overlay').classList.remove('active');}
function toggleDark(){document.body.classList.toggle('dark');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function el(id){return document.getElementById(id);}
function fmt(n){return Number(n||0).toFixed(2)+' â‚¬';}
function toast(msg,type='s'){
  const t=el('toast'),m=el('toastMsg'),i=el('toastIco');
  t.className='toast '+type+' show';
  m.textContent=msg;
  i.textContent=type==='s'?'âœ“':type==='e'?'âœ—':type==='w'?'âš ':'â„¹';
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),3500);
}

setInterval(()=>{if(currentUser)loadAll();},60000);
</script>
</body>
</html>